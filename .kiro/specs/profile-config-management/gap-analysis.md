# Gap Analysis: Profile Configuration Management

## Executive Summary

The dotfiles repository already has **strong foundation** for profile-based configuration management with most core functionality implemented. The primary gaps are:

- **Missing direct `git config --global` execution** during setup/sync based on profile
- **SSH key generation not integrated** with profile selection flow
- **Profile persistence** in `.gitconfig.roles` file (currently manual update)
- **Email extraction** from `.gitconfig.roles` for SSH key generation

**Implementation Approach**: **Option A - Extend Existing Components** (90% implemented, minor enhancements needed)

**Effort**: **S (1-3 days)** - Most features exist, need refinement and integration

**Risk**: **Low** - Well-established patterns, clear integration points, minimal architectural changes

---

## 1. Current State Investigation

### Existing Assets

#### Core Scripts (scripts/)

- **setup.sh**: Main orchestrator with profile selection (personal/work), exports `DOTFILES_PROFILE`
- **sync.sh**: Comprehensive Git config generation system with conditional includes, legacy migration, validation
- **brews.sh**: Profile-aware package installation (common + work-specific CLI tools)
- **casks.sh**: Profile-aware GUI app installation
- **ssh-key.sh**: Standalone SSH key generator (both personal/work keys)
- **backup.sh**: Timestamped backup system for existing dotfiles
- **git-config-status.sh**: Configuration validation and status display

#### Configuration Files (src/)

- **.gitconfig.roles**: Template with `GIT_PERSONAL_*`, `GIT_WORK_*`, `GIT_WORK_PATTERNS[]`, `GIT_DEFAULT_ROLE`
- **.gitconfig**: Main config with conditional `includeIf` directives (auto-generated by sync.sh)
- **.gitconfig.personal/.work**: Role-specific identity files (auto-generated)
- **.profile**: Legacy config with manual Git identity setting (deprecated but functional)

### Architecture Patterns

**Profile Flow**:

```
setup.sh → Profile prompt → export DOTFILES_PROFILE →
  brews.sh (checks $DOTFILES_PROFILE) →
  casks.sh (checks $DOTFILES_PROFILE) →
  sync.sh "$DOTFILES_PROFILE" (updates GIT_DEFAULT_ROLE)
```

**Git Identity System** (Current):

```
.gitconfig.roles (source of truth)
  ↓ (sync.sh reads & generates)
.gitconfig.personal + .gitconfig.work
  ↓ (conditional includes in main .gitconfig)
Auto-switching based on directory patterns
```

**Conventions**:

- Error handling: `set -euo pipefail` + color-coded logging (info/success/error)
- Idempotency: Check before install pattern (`brew list | grep`)
- Safety: Backup-first approach, validation before applying
- Modularity: Single responsibility per script

### Integration Points

- **Environment Variables**: `DOTFILES_PROFILE` passed from setup.sh to all child scripts
- **File Generation**: sync.sh generates `.gitconfig.*` files from `.gitconfig.roles` template
- **Git Conditional Includes**: Main `.gitconfig` uses `includeIf "gitdir:..."` for auto-switching
- **Backup System**: Timestamped `~/.dotfiles_backup_*` directories
- **SSH Config**: `~/.ssh/config` with host-based key selection (`github.com-personal`, `github.com-work`)

---

## 2. Requirements Feasibility Analysis

### Technical Needs Mapping

| Requirement                         | Technical Component                              | Current Status                                                            |
| ----------------------------------- | ------------------------------------------------ | ------------------------------------------------------------------------- |
| **R1: Profile Selection**           | setup.sh prompt + DOTFILES_PROFILE export        | ✅ **IMPLEMENTED**                                                        |
| **R1: Profile Persistence**         | Write to .gitconfig.roles GIT_DEFAULT_ROLE       | ⚠️ **PARTIAL** - sync.sh updates, but not during initial setup            |
| **R2: Git Global Config Execution** | `git config --global user.name/email`            | ❌ **MISSING** - Only file-based includes exist                           |
| **R2: Git File Generation**         | sync.sh generates .gitconfig.personal/.work      | ✅ **IMPLEMENTED**                                                        |
| **R2: Conditional Includes**        | includeIf directives in .gitconfig               | ✅ **IMPLEMENTED**                                                        |
| **R3: SSH Key Generation**          | ssh-key.sh creates both keys                     | ✅ **IMPLEMENTED**                                                        |
| **R3: SSH Key Integration**         | Use profile email for key comments               | ⚠️ **PARTIAL** - Hardcoded emails, not from .gitconfig.roles              |
| **R3: SSH Config Update**           | Host-based key selection in ~/.ssh/config        | ✅ **IMPLEMENTED**                                                        |
| **R4: Profile Email Consistency**   | Unified email source                             | ⚠️ **PARTIAL** - Multiple sources (.profile, .gitconfig.roles, hardcoded) |
| **R5: Config Validation**           | git-config-status.sh                             | ✅ **IMPLEMENTED**                                                        |
| **R6: Legacy Migration**            | sync.sh migrate_legacy_config()                  | ✅ **IMPLEMENTED**                                                        |
| **R7: Profile-Specific Packages**   | brews.sh + casks.sh with DOTFILES_PROFILE checks | ✅ **IMPLEMENTED**                                                        |
| **R8: Backup System**               | backup.sh + sync.sh backup                       | ✅ **IMPLEMENTED**                                                        |
| **R9: Sync Idempotency**            | Safe re-run capability                           | ✅ **IMPLEMENTED**                                                        |
| **R10: Configuration Template**     | .gitconfig.roles with documentation              | ✅ **IMPLEMENTED**                                                        |

### Identified Gaps

#### **Gap 1: Direct Git Global Config Execution** ❌

**Requirement**: R2.1-R2.5
**Current**: No `git config --global` commands executed during setup or sync
**Impact**: Users rely only on file-based conditional includes; global fallback not set correctly
**Constraint**: Need to source `.gitconfig.roles` and execute commands based on profile

#### **Gap 2: SSH Key Profile Integration** ⚠️

**Requirement**: R3.3-R3.4, R4.1
**Current**: ssh-key.sh uses hardcoded emails as default arguments
**Impact**: Email inconsistency if `.gitconfig.roles` differs from ssh-key.sh defaults
**Constraint**: Need to read emails from `.gitconfig.roles` dynamically

#### **Gap 3: Profile Persistence in Setup Flow** ⚠️

**Requirement**: R1.3
**Current**: sync.sh updates `GIT_DEFAULT_ROLE`, but setup.sh doesn't persist initially
**Impact**: Minor - sync.sh fixes it, but initial setup has gap between prompt and persistence
**Constraint**: Need setup.sh to update `.gitconfig.roles` before calling sync.sh

#### **Gap 4: Setup Integration with ssh-key.sh** ⚠️

**Requirement**: R4.1
**Current**: ssh-key.sh not called by setup.sh, manual execution required
**Impact**: Users must separately run ssh-key.sh with correct emails
**Constraint**: Need to integrate ssh-key.sh into setup.sh flow with profile-based email passing

### Complexity Signals

- **Simple**: Git config execution (standard commands, clear pattern)
- **Simple**: Profile persistence (single file update)
- **Moderate**: SSH integration (coordinate email sources, optional execution)
- **Low Risk**: All patterns established, well-tested foundation

---

## 3. Implementation Approach Options

### **Option A: Extend Existing Components** ⭐ **RECOMMENDED**

**Rationale**: 90% of functionality already implemented with clean patterns. Minor enhancements fit naturally.

#### Files to Extend

**1. scripts/sync.sh** - Add Git global config execution

- **Location**: After `generate_git_configs()` success
- **Changes**:
  - Add new function `set_git_global_config()` that sources `.gitconfig.roles` and executes:
    - `git config --global user.name "$GIT_PERSONAL_NAME"` (if personal)
    - `git config --global user.email "$GIT_PERSONAL_EMAIL"` (if personal)
    - `git config --global user.name "$GIT_WORK_NAME"` (if work)
    - `git config --global user.email "$GIT_WORK_EMAIL"` (if work)
  - Call from main sync flow after config generation
  - Respect `PROFILE_CHOICE` argument or `GIT_DEFAULT_ROLE` from `.gitconfig.roles`
- **Compatibility**: Fully backward compatible, enhances existing system
- **Lines**: ~30 lines added

**2. scripts/setup.sh** - Add profile persistence and SSH key integration

- **Location**: After profile selection (line ~30), before calling other scripts
- **Changes**:
  - Add function to update `GIT_DEFAULT_ROLE` in `src/.gitconfig.roles` immediately after profile selection
  - Add optional ssh-key.sh execution (prompt user: "Generate SSH keys? [y/N]")
  - Pass profile-based emails to ssh-key.sh from `.gitconfig.roles`
- **Compatibility**: No breaking changes, adds optional features
- **Lines**: ~40 lines added

**3. scripts/ssh-key.sh** - Make email extraction dynamic

- **Location**: Top of script (line ~15)
- **Changes**:
  - If `.gitconfig.roles` exists, source it and use `GIT_PERSONAL_EMAIL`/`GIT_WORK_EMAIL`
  - Keep existing defaults as fallback for standalone execution
  - Remove hardcoded email defaults from argument processing
- **Compatibility**: Backward compatible, works standalone or integrated
- **Lines**: ~15 lines modified

#### Integration Points

- setup.sh → updates `.gitconfig.roles` → calls sync.sh → sync.sh reads `.gitconfig.roles` → executes `git config --global`
- setup.sh → prompts for SSH keys → calls ssh-key.sh with emails from `.gitconfig.roles`
- All changes respect existing error handling and logging patterns

#### Complexity Assessment

- **Cognitive Load**: Low - follows established patterns (source files, check conditions, execute commands)
- **File Size**: Manageable - sync.sh already 317 lines, +30 is 10% increase
- **Maintainability**: High - clear separation of concerns, well-documented

#### Trade-offs

✅ **Pros**:

- Minimal new code, leverages existing infrastructure
- Preserves all current functionality
- Natural fit with established patterns
- Low testing burden (extend existing test paths)
- Fast implementation (1-3 days)

❌ **Cons**:

- Slightly increases size of already-large sync.sh
- Adds conditional logic to setup.sh

---

### **Option B: Create New Profile Manager Script**

**When to consider**: If profile management becomes significantly more complex (multiple profiles, profile switching, profile templates)

**Rationale**: Separate script `scripts/profile-manager.sh` to centralize all profile operations

#### Structure

```bash
scripts/profile-manager.sh
  - select_profile()
  - persist_profile()
  - set_git_config()
  - generate_ssh_keys()
  - validate_profile_config()
```

#### Integration

- setup.sh calls `profile-manager.sh select` instead of inline prompt
- sync.sh calls `profile-manager.sh set-git-config "$PROFILE"`
- Centralizes all profile logic in one place

#### Trade-offs

✅ **Pros**:

- Clean separation of concerns
- Easier to extend for future profile features
- Reduces cognitive load in individual scripts

❌ **Cons**:

- More files to navigate (new script)
- Adds indirection layer
- Overkill for current two-profile system
- Longer implementation time (3-5 days)
- Requires careful interface design

---

### **Option C: Hybrid - Minimal Extensions + Documentation**

**When to consider**: If speed is critical and users can handle minor manual steps

**Rationale**: Implement only critical missing piece (git config --global), document SSH integration

#### Changes

- **sync.sh only**: Add `git config --global` execution after file generation
- **Documentation**: Update README with SSH key setup instructions including email sourcing

#### Trade-offs

✅ **Pros**:

- Fastest implementation (<1 day)
- Minimal code changes
- Lowest risk

❌ **Cons**:

- SSH keys remain manual step
- Profile persistence gap remains
- Incomplete solution to stated requirements
- User experience not fully automated

---

## 4. Implementation Complexity & Risk

### Effort Estimate: **S (1-3 days)**

**Breakdown** (Option A):

- Day 1: Implement `set_git_global_config()` in sync.sh + unit testing
- Day 2: Integrate profile persistence and SSH prompt in setup.sh
- Day 3: Update ssh-key.sh email sourcing + integration testing + documentation

**Justification**:

- Extending established patterns (not creating new architecture)
- Clear code locations identified
- No external dependencies or unfamiliar tech
- Straightforward integration testing

### Risk Assessment: **Low**

**Risk Factors**:

- ✅ **Familiar Tech**: All Zsh scripting, Git commands - no unknowns
- ✅ **Clear Integration**: Well-defined interfaces between scripts
- ✅ **Known Performance**: Git config commands are fast, no scalability concerns
- ✅ **Minimal Impact**: Changes are additive, existing functionality untouched
- ✅ **Established Patterns**: Error handling, logging, validation already in place
- ✅ **Easy Rollback**: Changes are isolated, can revert individual files

**Mitigation**:

- Test with both personal and work profiles
- Verify Git version compatibility (2.13+ for conditional includes)
- Validate SSH key generation with different email formats
- Ensure idempotency (safe re-run of setup/sync)

---

## 5. Recommendations for Design Phase

### Preferred Approach: **Option A - Extend Existing Components**

**Justification**:

- 90% functionality already exists
- Clean patterns established
- Low risk, fast implementation
- Meets all requirements
- Maintains architectural consistency

### Key Design Decisions Needed

1. **Git Global Config Strategy**:

   - Decision: When to execute `git config --global` (setup only, sync always, or conditional)
   - Recommendation: Execute in sync.sh always (ensures consistency on updates)
   - Trade-off: Overwrites any manual user changes to global config

2. **SSH Key Integration Level**:

   - Decision: Required step vs optional prompt vs fully manual
   - Recommendation: Optional prompt in setup.sh with clear instructions
   - Trade-off: Optional means some users may skip, but forced SSH generation is aggressive

3. **Email Source of Truth**:

   - Decision: Consolidate all email usage to `.gitconfig.roles` vs maintain flexibility
   - Recommendation: `.gitconfig.roles` as single source, with fallbacks for backward compatibility
   - Trade-off: Requires users to maintain one file, but simpler mental model

4. **Profile Switching Post-Setup**:
   - Decision: Support changing profiles after initial setup
   - Recommendation: Allow re-running `sync.sh <new-profile>` to switch
   - Trade-off: Need to ensure clean state transitions (git config updates, etc.)

### Research Items (None Required)

All technical needs are understood:

- ✅ Git config commands are standard and well-documented
- ✅ File sourcing in Zsh is straightforward
- ✅ SSH key generation patterns already implemented
- ✅ Conditional include syntax already in use

**No external research needed** - proceed directly to detailed design.

---

## 6. Requirement-to-Asset Gap Map

| Requirement                           | Existing Asset                     | Gap Status      | Notes                       |
| ------------------------------------- | ---------------------------------- | --------------- | --------------------------- |
| **R1.1** Profile prompt               | setup.sh lines 15-32               | ✅ **COMPLETE** | Prompt implemented          |
| **R1.2** Export DOTFILES_PROFILE      | setup.sh lines 24,27               | ✅ **COMPLETE** | Export working              |
| **R1.3** Persist in .gitconfig.roles  | sync.sh line 126                   | ⚠️ **PARTIAL**  | Sync updates, setup doesn't |
| **R1.4** Invalid selection error      | setup.sh lines 30-33               | ✅ **COMPLETE** | Error handling exists       |
| **R1.5** Pass profile to scripts      | setup.sh line 73                   | ✅ **COMPLETE** | Passed to sync.sh           |
| **R2.1** Execute git config name      | N/A                                | ❌ **MISSING**  | Need to add function        |
| **R2.2** Execute git config email     | N/A                                | ❌ **MISSING**  | Need to add function        |
| **R2.3** Use personal values          | N/A                                | ❌ **MISSING**  | Logic needed                |
| **R2.4** Use work values              | N/A                                | ❌ **MISSING**  | Logic needed                |
| **R2.5** Sync updates git config      | N/A                                | ❌ **MISSING**  | Need integration            |
| **R2.6** Generate .gitconfig.personal | sync.sh lines 149-159              | ✅ **COMPLETE** | Fully implemented           |
| **R2.7** Generate .gitconfig.work     | sync.sh lines 162-172              | ✅ **COMPLETE** | Fully implemented           |
| **R2.8** Generate includeIf sections  | sync.sh lines 208-220              | ✅ **COMPLETE** | Fully implemented           |
| **R2.9** Work pattern matching        | Git native                         | ✅ **COMPLETE** | Conditional includes work   |
| **R2.10** Personal fallback           | sync.sh lines 226-229              | ✅ **COMPLETE** | Default include added       |
| **R2.11** Apply GIT_DEFAULT_ROLE      | sync.sh line 126                   | ✅ **COMPLETE** | Implemented                 |
| **R2.12** Validation errors           | sync.sh lines 139-147              | ✅ **COMPLETE** | Error checking exists       |
| **R2.13** Git version check           | sync.sh lines 18-36                | ✅ **COMPLETE** | Version validation present  |
| **R3.1** Check personal SSH key       | ssh-key.sh lines 27-30             | ✅ **COMPLETE** | Check implemented           |
| **R3.2** Check work SSH key           | ssh-key.sh lines 33-36             | ✅ **COMPLETE** | Check implemented           |
| **R3.3** Generate personal key        | ssh-key.sh line 29                 | ⚠️ **PARTIAL**  | Hardcoded email             |
| **R3.4** Generate work key            | ssh-key.sh line 35                 | ⚠️ **PARTIAL**  | Hardcoded email             |
| **R3.5** Add to ssh-agent             | ssh-key.sh lines 47-48             | ✅ **COMPLETE** | Implemented                 |
| **R3.6** Update SSH config            | ssh-key.sh lines 53-74             | ✅ **COMPLETE** | Host-based config           |
| **R3.7** Create .ssh directory        | ssh-key.sh lines 23-24             | ✅ **COMPLETE** | Directory creation          |
| **R4.1** Use email for SSH gen        | N/A                                | ⚠️ **PARTIAL**  | Need integration            |
| **R4.2** Personal profile Git email   | sync.sh line 151                   | ✅ **COMPLETE** | From .gitconfig.roles       |
| **R4.3** Work profile Git email       | sync.sh line 165                   | ✅ **COMPLETE** | From .gitconfig.roles       |
| **R4.4** Regenerate on update         | sync.sh generate_git_configs()     | ✅ **COMPLETE** | Called on sync              |
| **R4.5** Email consistency            | N/A                                | ⚠️ **PARTIAL**  | Need unified source         |
| **R5.1** Display global config        | git-config-status.sh lines 76-87   | ✅ **COMPLETE** | Implemented                 |
| **R5.2** Show active identity         | git-config-status.sh lines 103-125 | ✅ **COMPLETE** | Pattern matching            |
| **R5.3** Indicate work active         | git-config-status.sh line 117      | ✅ **COMPLETE** | Display logic               |
| **R5.4** Indicate personal active     | git-config-status.sh line 126      | ✅ **COMPLETE** | Display logic               |
| **R5.5** List work patterns           | git-config-status.sh lines 138-142 | ✅ **COMPLETE** | Pattern listing             |
| **R5.6** Warn missing roles           | git-config-status.sh lines 59-61   | ✅ **COMPLETE** | Warning present             |
| **R6.1-R6.6** Legacy migration        | sync.sh lines 38-110               | ✅ **COMPLETE** | Full migration logic        |
| **R7.1-R7.5** Profile packages        | brews.sh + casks.sh                | ✅ **COMPLETE** | Conditional install         |
| **R8.1-R8.5** Backup system           | backup.sh + sync.sh                | ✅ **COMPLETE** | Timestamped backups         |
| **R9.1-R9.5** Idempotency             | All scripts                        | ✅ **COMPLETE** | Check-before-act pattern    |
| **R10.1-R10.6** Config template       | src/.gitconfig.roles               | ✅ **COMPLETE** | Documented template         |

**Summary**:

- ✅ **COMPLETE**: 48/56 requirements (86%)
- ⚠️ **PARTIAL**: 5/56 requirements (9%)
- ❌ **MISSING**: 3/56 requirements (5%)

**Missing Requirements**: All relate to direct `git config --global` command execution (R2.1-R2.5)

---

## Conclusion

The dotfiles repository has a **mature, well-architected profile management system** with 86% requirement coverage. The gaps are narrow and well-defined:

1. Add `git config --global` execution in sync.sh (30 lines)
2. Persist profile selection in setup.sh (15 lines)
3. Integrate SSH key generation with profile emails (40 lines)

**Recommended path**: Extend existing components (Option A) with **1-3 day effort** and **low risk**.

No technical unknowns or research needed - proceed directly to detailed design phase.
